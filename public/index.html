
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>SIBI – Should I Buy It</title>
  <style>
    body { font-family: sans-serif; padding: 20px; }
    .progress { margin-top: 10px; height: 20px; background: #eee; width: 100%; border-radius: 4px; overflow: hidden; }
    .progress-bar { height: 100%; background: #4caf50; width: 0%; transition: width 0.3s ease; }
    table { border-collapse: collapse; margin-top: 20px; width: 100%; }
    th, td { border: 1px solid #ccc; padding: 6px; text-align: left; }
    .modal { display: none; position: fixed; z-index: 999; left: 0; top: 0; width: 100%; height: 100%; overflow: auto;
             background-color: rgba(0,0,0,0.6); }
    .modal-content { background-color: #fff; margin: 10% auto; padding: 20px; width: 60%; border-radius: 6px; }
    .close { color: #aaa; float: right; font-size: 28px; font-weight: bold; }
    .close:hover, .close:focus { color: black; text-decoration: none; cursor: pointer; }
  </style>
</head>
<body>
  <h1>SIBI – Should I Buy It</h1>
  <input type="file" id="imageUpload" multiple accept="image/*" />
  <button onclick="startAnalysis()">Start Analysis</button>

  <div class="progress"><div class="progress-bar" id="progressBar"></div></div>
  <div id="results"></div>

  <!-- Modal -->
  <div id="priceModal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="document.getElementById('priceModal').style.display='none'">&times;</span>
      <div id="modalBody"></div>
    </div>
  </div>

  <script>
    async function startAnalysis() {
      const files = document.getElementById('imageUpload').files;
      if (!files.length) return alert("Please upload at least one image.");

      const progressBar = document.getElementById("progressBar");
      progressBar.style.width = "10%";

      const formData = new FormData();
      for (const file of files) formData.append('images', file);
      progressBar.style.width = "30%";

      const analyseRes = await fetch('/api/analyse-image', { method: 'POST', body: formData });
      const items = await analyseRes.json();
      progressBar.style.width = "60%";

      const ebayRes = await fetch('/api/fetch-ebay', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ items })
      });
      const data = await ebayRes.json();
      progressBar.style.width = "100%";

      renderResults(data);
    }

    function renderResults(data) {
      const div = document.getElementById("results");
      let html = "<h2>Top 3 Most Valuable Items</h2><ul>";
      for (const item of data.top3) html += `<li>${item.name} – ${item.value}</li>`;
      html += "</ul><h2>All Items</h2><table><tr><th>Item</th><th>Value</th><th>Sold</th><th>Available</th><th>eBay</th></tr>";
      data.items.forEach((item, i) => {
        html += `<tr>
          <td>${item.name}</td>
          <td><a href="#" onclick="showDetails(${i}); return false;">${item.value}</a></td>
          <td>${item.sold}</td>
          <td>${item.available}</td>
          <td><a href="${item.link}" target="_blank">View</a></td>
        </tr>`;
      });
      html += "</table><h2>Summary</h2><p>" + data.summary + "</p>";
      div.innerHTML = html;
      window._sibiData = data.items;
    }

    function showDetails(index) {
      const item = window._sibiData[index];
      const modal = document.getElementById("priceModal");
      const body = document.getElementById("modalBody");

      if (!item || !item.soldItems?.length) {
        body.innerHTML = "<strong>No recent sales data available.</strong>";
      } else {
        const avg = item.soldItems.reduce((a, b) => a + parseFloat(b.price), 0) / item.soldItems.length;
        body.innerHTML = "<strong>" + item.name + "</strong><br><br>Last 10 Sold Items:<ul>" +
          item.soldItems.map(p => `<li><a href="${p.url}" target="_blank">$${parseFloat(p.price).toFixed(2)}</a></li>`).join("") +
          `</ul><br><strong>Average:</strong> $${avg.toFixed(2)} AUD`;
      }

      modal.style.display = "block";
    }

    window.onclick = function(event) {
      const modal = document.getElementById("priceModal");
      if (event.target === modal) modal.style.display = "none";
    }
  </script>
</body>
</html>
