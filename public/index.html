
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>SIBI – Should I Buy It</title>
  <style>
    body { font-family: sans-serif; padding: 20px; }
    .progress { margin-top: 10px; height: 20px; background: #eee; width: 100%; border-radius: 4px; overflow: hidden; }
    .progress-bar { height: 100%; background: #4caf50; width: 0%; transition: width 0.3s ease; }
    table { border-collapse: collapse; margin-top: 20px; width: 100%; }
    th, td { border: 1px solid #ccc; padding: 6px; text-align: left; }
    .price-detail { font-size: 14px; margin-top: 10px; padding: 6px; border: 1px solid #ccc; background: #f9f9f9; }
  </style>
</head>
<body>
  <h1>SIBI – Should I Buy It</h1>
  <input type="file" id="imageUpload" multiple accept="image/*" />
  <button onclick="startAnalysis()">Start Analysis</button>

  <div class="progress"><div class="progress-bar" id="progressBar"></div></div>
  <div id="results"></div>

  <script>
    async function startAnalysis() {
      const files = document.getElementById('imageUpload').files;
      if (!files.length) return alert("Please upload at least one image.");

      const progressBar = document.getElementById("progressBar");
      progressBar.style.width = "10%";

      const formData = new FormData();
      for (const file of files) formData.append('images', file);
      progressBar.style.width = "30%";

      const analyseRes = await fetch('/api/analyse-image', { method: 'POST', body: formData });
      const items = await analyseRes.json();
      progressBar.style.width = "60%";

      const ebayRes = await fetch('/api/fetch-ebay', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ items })
      });
      const data = await ebayRes.json();
      progressBar.style.width = "100%";

      renderResults(data);
    }

    function renderResults(data) {
      const div = document.getElementById("results");
      let html = "<h2>Top 3 Most Valuable Items</h2><ul>";
      for (const item of data.top3) html += `<li>${item.name} – ${item.value}</li>`;
      html += "</ul><h2>All Items</h2><table><tr><th>Item</th><th>Value</th><th>Sold</th><th>Available</th><th>eBay</th></tr>";
      data.items.forEach((item, i) => {
        html += `<tr>
          <td>${item.name}</td>
          <td><a href="#" onclick="showDetails(${i}); return false;">${item.value}</a></td>
          <td>${item.sold}</td>
          <td>${item.available}</td>
          <td><a href="${item.link}" target="_blank">View</a></td>
        </tr>`;
      });
      html += "</table><h2>Summary</h2><p>" + data.summary + "</p>";
      html += "<div id='detailBox' class='price-detail'></div>";
      div.innerHTML = html;
      window._sibiData = data.items;
    }

    function showDetails(index) {
      const item = window._sibiData[index];
      const box = document.getElementById("detailBox");
      if (!item || !item.soldPrices?.length) {
        box.innerHTML = "<strong>No recent sales data available.</strong>";
        return;
      }

      const avg = item.soldPrices.reduce((a, b) => a + b, 0) / item.soldPrices.length;
      box.innerHTML = "<strong>" + item.name + "</strong><br>Last 10 Sold Prices:<ul>" +
      item.soldPrices.map((p, i) => `<li><a href="${item.soldLinks?.[i] || "#"}" target="_blank">$${p.toFixed(2)}</a></li>`).join("") +
        `</ul><strong>Average:</strong> $${avg.toFixed(2)} AUD`;
    }
  </script>
</body>
</html>
